name: Monthly Data Update

on:
  # Run on the 1st of every month at 2 AM UTC
  schedule:
    - cron: '0 2 1 * *'
  
  # Allow manual triggering from GitHub UI
  workflow_dispatch:

jobs:
  update-earthquake-data:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests sqlalchemy psycopg2-binary python-dotenv
      
      - name: Fetch USGS Earthquake Data
        env:
          DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
        run: python backend/scripts/fetch_earthquake_data.py --days=30 --min-magnitude=4.0
      
      - name: Log completion
        run: echo "âœ… Earthquake data updated successfully"

  update-volcanic-data:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests sqlalchemy psycopg2-binary python-dotenv
      
      - name: Fetch Volcanic Activity Data
        env:
          DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
        run: python backend/scripts/fetch_volcanic_data_standalone.py
      
      - name: Log completion
        run: echo "âœ… Volcanic data updated successfully"

  update-neo-data:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests sqlalchemy psycopg2-binary python-dotenv
      
      - name: Fetch NASA NEO Data
        env:
          DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
        run: python backend/scripts/fetch_neo_data.py --days=90
      
      - name: Log completion
        run: echo "âœ… NEO data updated successfully"

  update-solar-events:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests sqlalchemy psycopg2-binary python-dotenv
      
      - name: Fetch Solar Event Data
        env:
          DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
        run: python backend/scripts/fetch_solar_events.py --days=30
      
      - name: Log completion
        run: echo "âœ… Solar event data updated successfully"

  recalculate-correlations:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    continue-on-error: true
    needs: [update-earthquake-data, update-volcanic-data, update-neo-data, update-solar-events]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install sqlalchemy psycopg2-binary python-dotenv numpy scikit-learn
      
      - name: Recalculate ML Correlations
        env:
          DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
        run: python backend/scripts/recalculate_correlations.py
      
      - name: Log completion
        run: echo "âœ… ML correlations recalculated successfully"
      
      - name: Send completion notification
        run: |
          echo "ðŸŽ‰ Monthly data update completed!"
          echo "Updated: Earthquakes, Volcanoes, NEOs, Solar Events"
          echo "Timestamp: $(date -u)"
